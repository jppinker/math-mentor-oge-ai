import { getRandomMathProblem } from "@/services/mathProblemsService.ts";

// Groq API service for chat completions
export interface Message {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
// Use Vite's environment variable syntax instead of process.env
const VITE_GROQ_API_KEY = import.meta.env.VITE_GROQ_API_KEY;

// Check if API key is available
if (!VITE_GROQ_API_KEY) {
  console.error('VITE_GROQ_API_KEY is not set in environment variables');
}

// Enhanced system prompt for the math tutor
const SYSTEM_PROMPT: Message = {
  role: 'system',
  content: `You are "–Å–∂–∏–∫" (Hedgehog), a helpful and patient high school math teacher specializing in Russian OGE (–û–ì–≠) exam preparation. You explain math concepts step-by-step and adapt to the student's level. 

Key capabilities:
- Use LaTeX notation for mathematical expressions: inline math with \\(...\\) or $...$ and block math with \\[...\\] or $$...$$
- Keep responses in Russian language
- Break down complex topics into simple steps
- Answer general math questions and provide explanations
- Help students understand mathematical concepts

You can discuss any math-related topics, explain formulas, solve problems, and provide educational guidance. When students need practice problems, they will be provided automatically from our database.

Remember: You are a patient, encouraging teacher who helps students learn mathematics effectively through conversation and explanation.`
};

export async function streamChatCompletion(messages: Message[]): Promise<ReadableStream<Uint8Array> | null> {
  try {
    if (!VITE_GROQ_API_KEY) {
      throw new Error('VITE_GROQ_API_KEY is not set in environment variables');
    }
    
    const fullMessages = [SYSTEM_PROMPT, ...messages];
    
    console.log("üß™ [GroqService] Key type:", typeof VITE_GROQ_API_KEY);
    console.log("üß™ [GroqService] Key value:", VITE_GROQ_API_KEY);  // WARNING: temporary, don't expose in production!
    
    const response = await fetch(GROQ_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${VITE_GROQ_API_KEY}`
      },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        messages: fullMessages,
        stream: true
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('Groq API error:', errorData);
      throw new Error(`Groq API error: ${response.status}`);
    }

    return response.body;
  } catch (error) {
    console.error('Error streaming from Groq:', error);
    return null;
  }
}

export async function getChatCompletion(messages: Message[]): Promise<string> {
  try {
    const lastUserMessage = messages[messages.length - 1]?.content.toLowerCase();

    // Check if user asked for a math problem
    if (lastUserMessage.includes('–∑–∞–¥–∞—á—É')) {
      let category: string | undefined = undefined;

      if (lastUserMessage.includes('–∞–ª–≥–µ–±—Ä')) category = '–∞–ª–≥–µ–±—Ä–∞';
      else if (lastUserMessage.includes('–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫')) category = '–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞';
      else if (lastUserMessage.includes('–≥–µ–æ–º–µ—Ç—Ä')) category = '–≥–µ–æ–º–µ—Ç—Ä–∏—è';
      else if (lastUserMessage.includes('–ø—Ä–∞–∫—Ç–∏—á')) category = '–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞';

      const problem = await getRandomMathProblem(category);

      if (problem) {
        const imagePart = problem.problem_image ? `üñºÔ∏è ![–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ](${problem.problem_image})\n\n` : "";
        return `–í–æ—Ç –∑–∞–¥–∞—á–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *${category ?? '–û–±—â–µ–µ'}*:\n\n${imagePart}${problem.problem_text}\n\n–ù–∞–ø–∏—à–∏ *–ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç* –∏–ª–∏ *–ø–æ–∫–∞–∂–∏ —Ä–µ—à–µ–Ω–∏–µ*, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.`;
      }

      return "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á—É. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ.";
    }

    // Default: go to Groq
    const fullMessages = [SYSTEM_PROMPT, ...messages];
    const response = await fetch(GROQ_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${VITE_GROQ_API_KEY}`
      },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        messages: fullMessages
      })
    });

    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    console.error('Chat completion error:', error);
    return '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
  }
}
